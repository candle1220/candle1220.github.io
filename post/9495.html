<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>4.网络层 | Night's Watch</title><meta name="keywords" content="计算机网络"><meta name="author" content="Candle"><meta name="copyright" content="Candle"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="网络层概述网络层的主要任务是实现网络互连，进而实现数据包在各网络之间的传输 主要要解决以下主要问题：  网络层向运输层提供的是可靠传输还是不可靠传输 网络层寻址问题 路由选择问题   网络层提供的服务面向连接的虚电路服务  核心思想是可靠通信由网络来保证  必须建立网络层的连接—–虚电路VC  目的主机的地址仅在连接建立阶段使用，之后每个分组的首部只需携带一条虚电路的编号    这种通信方式如果再">
<meta property="og:type" content="article">
<meta property="og:title" content="4.网络层">
<meta property="og:url" content="http://candle1220.github.io/post/9495.html">
<meta property="og:site_name" content="Night&#39;s Watch">
<meta property="og:description" content="网络层概述网络层的主要任务是实现网络互连，进而实现数据包在各网络之间的传输 主要要解决以下主要问题：  网络层向运输层提供的是可靠传输还是不可靠传输 网络层寻址问题 路由选择问题   网络层提供的服务面向连接的虚电路服务  核心思想是可靠通信由网络来保证  必须建立网络层的连接—–虚电路VC  目的主机的地址仅在连接建立阶段使用，之后每个分组的首部只需携带一条虚电路的编号    这种通信方式如果再">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg">
<meta property="article:published_time" content="2021-12-28T15:51:19.926Z">
<meta property="article:modified_time" content="2022-03-04T16:36:39.321Z">
<meta property="article:author" content="Candle">
<meta property="article:tag" content="计算机网络">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg"><link rel="shortcut icon" href="/img/candle.png"><link rel="canonical" href="http://candle1220.github.io/post/9495"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '4.网络层',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-05 00:36:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/candle1220/CDN/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">144</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-crow"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-book"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/record/"><i class="fa-fw fas fa-atom"></i><span> 日志</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/candle1220/CDN/background.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Night's Watch</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-crow"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-book"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/record/"><i class="fa-fw fas fa-atom"></i><span> 日志</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">4.网络层</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-28T15:51:19.926Z" title="发表于 2021-12-28 23:51:19">2021-12-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-04T16:36:39.321Z" title="更新于 2022-03-05 00:36:39">2022-03-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="4.网络层"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>网络层的主要任务是实现网络互连，进而实现数据包在各网络之间的传输</p>
<p>主要要解决以下主要问题：</p>
<ul>
<li>网络层向运输层提供的是可靠传输还是不可靠传输</li>
<li>网络层寻址问题</li>
<li>路由选择问题</li>
</ul>
<hr>
<h2 id="网络层提供的服务"><a href="#网络层提供的服务" class="headerlink" title="网络层提供的服务"></a>网络层提供的服务</h2><p>面向连接的虚电路服务</p>
<ul>
<li><p>核心思想是可靠通信由网络来保证</p>
</li>
<li><p>必须建立网络层的连接—–虚电路VC</p>
</li>
<li><p>目的主机的地址仅在连接建立阶段使用，之后每个分组的首部只需携带一条虚电路的编号</p>
</li>
</ul>
<p><img src="https://s2.loli.net/2021/12/29/EpZB6nkU71dWc3m.png" alt="image-20210507104138583"></p>
<p>这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组最终正确到达接收方</p>
<p>通信结束后，需要释放之前所建立的虚电路</p>
<p>然而因特网并没有采用这种方法</p>
<hr>
<p>无连接的数据报服务</p>
<ul>
<li><p>可靠通信应当由用户主机来保证</p>
</li>
<li><p>不需要建立网络层连接</p>
</li>
<li><p>每个分组可走不同的路径</p>
</li>
<li><p>每个分组的首部必须携带目的分组的完整地址</p>
</li>
</ul>
<p><img src="https://s2.loli.net/2021/12/29/ZocIlWz1MdHXBAF.png" alt="image-20210507104439633"></p>
<p>这种通信方式所传送的分组可能误码，丢失，重复和失序</p>
<p>由于网络本身不采用端到端的可靠传输服务，所以网络中的路由器就可以做的比较简单，而且价格低廉，因特网采用了这种设计思想，将复杂的网络处理功能置于因特网的边缘，而将相对简单的尽最大努力的分组交付功能置于因特网核心</p>
<p><img src="https://s2.loli.net/2021/12/29/6OoxKNLTFqAJGcy.png" alt="image-20210507104654352"></p>
<hr>
<h2 id="IPv4地址"><a href="#IPv4地址" class="headerlink" title="IPv4地址"></a>IPv4地址</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><p>IPv4就是给因特网上每一台主机（或路由器）的每一个接口分配一个在全世界范围内是唯一的32比特的标识符</p>
<p>IP地址由因特网名字和数据分配机构ICANN进行分配</p>
<p>IPv4地址的编址方法经历了3个阶段：分类编址    划分子网    无分类编址</p>
<p>IPv4地址由32个比特组成，采用点分十进制表示方法以方便用户使用</p>
<p><img src="https://s2.loli.net/2021/12/29/arx6pTyMLq25eSW.png" alt="image-20210507110644819"></p>
<hr>
<h3 id="分类编址的IPv4地址"><a href="#分类编址的IPv4地址" class="headerlink" title="分类编址的IPv4地址"></a>分类编址的IPv4地址</h3><p>分为A类地址 B类地址 C类地址 D类地址 E类地址</p>
<p><img src="https://s2.loli.net/2021/12/29/H3y5uzR6B8WbeAd.png" alt="image-20210507110823896"></p>
<ul>
<li><p>只有A类，B类，C类地址可以分配给网络各接口</p>
</li>
<li><p><strong>主机号为全0的地址是网络地址</strong>，不能分配给主机或路由器接口</p>
</li>
<li><strong>主机号为全1的地址是广播地址</strong>，不能分配给主机或路由器接口</li>
</ul>
<p>A类</p>
<p><img src="https://s2.loli.net/2021/12/29/8vwSdIczJZ1rqnG.png" alt="image-20210507115249485"></p>
<p><strong>最小网络号0，保留不指派</strong></p>
<p>第一个可指派的网络号为1，网络地址为1.0.0.0</p>
<p><strong>最大网络号127，作为本地环回测试地址，不指派</strong></p>
<hr>
<p>B类</p>
<p> <img src="https://s2.loli.net/2021/12/29/kclJBEPbLNXvhGC.png" alt="image-20210507115314323"></p>
<p>最小网络号也是第一个可指派的网络号128.0 网络地址为128.0.0.0</p>
<p>最大网络号也是最后一个可指派的网络号191.255 网络地址为191.255.0.0</p>
<hr>
<p>C类</p>
<p><img src="https://s2.loli.net/2021/12/29/dDobkj2M3NSRZcU.png" alt="image-20210507115441232"></p>
<p>最小主机号也是第一个可指派的网络号192.0..0，网络地址为192.0.0.0</p>
<p>最大主机号也是最后一个可指派的网络号223.255.255，网络地址为223.255.255.0</p>
<hr>
<p><img src="https://s2.loli.net/2021/12/29/49KQEdYx5sp1omi.png" alt="image-20210507120510325"></p>
<hr>
<h3 id="划分子网的IPv4地址"><a href="#划分子网的IPv4地址" class="headerlink" title="划分子网的IPv4地址"></a>划分子网的IPv4地址</h3><p>如果需要的IP地址个数在在变化，如果每次都要申请，会很浪费IP地址</p>
<p>可以从主机号部分借用一部分比特作为子网号，计算机需要知道主机号中有多少位作为了子网号，所以需要<strong>子网掩码</strong></p>
<p>32bit的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号</p>
<ul>
<li>子网掩码使用连续的比特1来对应网络号和子网号</li>
<li>子网掩码使用连续的比特0来对应主机号</li>
<li>将划分子网的IPv4地址与其相应的子网掩码进行逻辑与运算就可以得到IPv4所在子网的网络地址</li>
</ul>
<p><img src="https://s2.loli.net/2021/12/29/mAunLsaNr4EW5Ze.png" alt="image-20210507121200065"></p>
<p>子网号占据了多少个1说明就借用了几个比特，1个子网号可以划分2个子网</p>
<hr>
<p>默认的子网掩码是指未划分子网的情况下使用的子网掩码</p>
<p><img src="https://s2.loli.net/2021/12/29/MvdG3ln7IazycmV.png" alt="image-20210507123011637"></p>
<p><img src="https://s2.loli.net/2021/12/29/cGUu9TQtpS2Mjhd.png" alt="image-20210507123018503"></p>
<p><img src="https://s2.loli.net/2021/12/29/5HdtK3YoPLcOqIV.png" alt="image-20210507123047394"></p>
<hr>
<h3 id="无分类编址的IPv4地址"><a href="#无分类编址的IPv4地址" class="headerlink" title="无分类编址的IPv4地址"></a>无分类编址的IPv4地址</h3><p>数量巨大的C类网因为地址空间太小并没有得到充分的运用，而因特网的IP地址在加速消耗，整个IPv4地址空间面临全面耗尽的威胁</p>
<p>为此，因特网工程任务组IETF又提出了采用无分类编址的方法</p>
<p>无分类域间路由选择CIDR(Classless Inter-Domain Routing)</p>
<ul>
<li>CIDR消除了传统A类，B类和C类地址，以及划分子网的概念</li>
<li>CIDR可以更加有效地分配IPv4的地址空间</li>
</ul>
<p>CIDR采用斜线记法，在IPv4地址后面加上斜线，在斜线后面写上<strong>网络前缀所占的比特数量</strong></p>
<p><img src="https://s2.loli.net/2021/12/29/Ed2gyKjrLZVzwN9.png" alt="image-20210507123900406"></p>
<p>CIDR实际上是将网络前缀都相同的连续的IP地址组成一个CIDR地址块</p>
<p>只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的全部细节</p>
<ul>
<li>地址块的最小地址，最大地址</li>
<li>地址块的地址数量</li>
<li>地址块聚合某类网络的数量</li>
<li>地址掩码</li>
</ul>
<p>路由聚合（构造超网）</p>
<p>将有很多共同前缀的路由信息通过CIDR的方式打包发送给另一个路由</p>
<p><img src="https://s2.loli.net/2021/12/29/aSsx9bHvjKTApgm.png" alt="image-20210507124504885"></p>
<p>聚合地址块：172.1.4.0/22</p>
<ul>
<li><p>网络前缀越长，地址块越小，路由越具体</p>
</li>
<li><p>如果路由器查表转发分组的时候发现有多条路由可选，则选择网络前缀最长的那条，称为最长前缀匹配，因为这样的路由更具体</p>
</li>
</ul>
<hr>
<h3 id="IPv4地址的应用规划"><a href="#IPv4地址的应用规划" class="headerlink" title="IPv4地址的应用规划"></a>IPv4地址的应用规划</h3><p>根据网络中主机和路由器的数目可以进行IPv4地址的划分，有两种方式</p>
<p>定长的子网掩码FLSM(Fixed Length Subnet Mask)</p>
<ul>
<li>使用同一个子网掩码来划分子网，每个子网分配的IP地址相同</li>
</ul>
<p>如果网络中子网数目是n个，那么最少需要借用$log_2n$个比特充当子网掩码</p>
<p>如果网络中子网的最大主机数是x个，那么根据网络类型，要确保主机地址被借用后，也可以有足够的地址满足要求</p>
<hr>
<p>变长的子网掩码VLSM(Variable Length Subnet Mask)</p>
<ul>
<li>使用不同的子网掩码来划分子网，每个子网分配的IP地址不同</li>
</ul>
<p>在分配地址的时候，每个子块的起点位置不能随意选取，只能选取块大小整数倍的地址作为起点</p>
<hr>
<h2 id="IP数据报发送和转发的过程"><a href="#IP数据报发送和转发的过程" class="headerlink" title="IP数据报发送和转发的过程"></a>IP数据报发送和转发的过程</h2><p><img src="https://s2.loli.net/2021/12/29/63fKrSG5hpJZl49.png" alt="image-20210507155405472"></p>
<p>每个网络中都有其网络地址和子网掩码</p>
<p>同一个网络中的自己可以直接通信，而不同网络中的主机则需要路由器进行中转</p>
<p>问题是源主机如何判断目的主机是否需要是同一个网络中的？</p>
<p>可以将目的主机与源主机的子网掩码相与来得到目的网络地址，该地址与源主机的网络地址不相等，就可以知道目的主机与源主机不在同一个网络</p>
<p>这样就要通过路由器来转发数据，又有一个问题，主机怎么知道路由器的存在？</p>
<p>实际上，每一个主机都必须指定一个路由器，称为<strong>默认网关</strong>，如果主机要通过路由器传输信息，则会把数据传输给默认网关</p>
<p><img src="https://s2.loli.net/2021/12/29/AsLZF7miplrxhKW.png" alt="image-20210507160139055"></p>
<p>如果路由器收到了IP数据报，该如何转发</p>
<ol>
<li>首先检查IP数据报，若出错，则直接丢弃该IP数据报，若没有出错，则直接进行转发</li>
<li>根据IP数据报的目的地址在路由表中查找匹配的条目：若找到匹配的条目，则转发给条目中指示的下一跳，若找不到，则丢弃数据报，并通告源主机</li>
</ol>
<p>路由器在配置的时候就知道了各个接口所连接的网络和地址掩码</p>
<p><img src="https://s2.loli.net/2021/12/29/Mt7DNdAY2TeRV1h.png" alt="image-20210507160639084"></p>
<p>将目的地址与地址掩码相与，得到目的网络地址，如果相同则转发，不同则查找下一个条目</p>
<hr>
<p>如果在网络中发送广播，即目的地址是广播地址，则广播只会在本网络中传播，而路由器会判断出是广播，不会进行转发，所以路由器可以隔离广播风暴</p>
<hr>
<h2 id="静态路由配置和路由环路"><a href="#静态路由配置和路由环路" class="headerlink" title="静态路由配置和路由环路"></a>静态路由配置和路由环路</h2><p>静态路由配置是指用户或网络管理员使用路由器的相关命令给路由器人工配置路由表</p>
<p>这样配置不能及时适应网络状态，可以出现以下导致路由环路的错误</p>
<ul>
<li>配置错误</li>
<li>聚合了不存在的网络</li>
<li>网络故障</li>
</ul>
<p><img src="https://s2.loli.net/2021/12/29/iVE4WbDHCRlKwha.png" alt="image-20210510142840511"></p>
<p>如果此时R1的收到的IP数据报要转发给目的主机，但是在R1中并没有相关路由配置</p>
<p>此时就需要给R1的路由表配置相关信息，使R1下一跳在R2</p>
<p><img src="https://s2.loli.net/2021/12/29/SZdKtCwg4kyjFXn.png" alt="image-20210510143204263"></p>
<p>如何R2接入了因特网，那么众多IP数据报需要通过R1转发到达R2，如果是一条一条配置的话工作量太大了，此时我们可以使用<strong>默认路由</strong>的概念</p>
<p><img src="https://s2.loli.net/2021/12/29/aVceqfF6WiMhQl2.png" alt="image-20210510143337978"></p>
<p>将目的网络设置成0.0.0.0/0，此时其他的IP数据报都会默认跳转到R2</p>
<p>有时候我们可以给路由器添加针对某个主机的<strong>特定主机路由条目</strong></p>
<p><img src="https://s2.loli.net/2021/12/29/bMV3DuOFcYHl89S.png" alt="image-20210510143718110"></p>
<p>如果要给192.168.2.1的主机添加特定主机路由配置，就在路由器中设置成192.168.2.1/32</p>
<p>这样网络的前缀最长，路由最具体，当路由器具有多种转发路径可以选择的时候，会采取最长前缀匹配原则，转发的时候会有最高的优先级</p>
<hr>
<p>路由配置错误导致的路由环路问题</p>
<p>假如R1收到数据要转发给R2，而R2的路由错误配置。导致R2的数据要转发回R1，那么就出现了路由环路的问题</p>
<p><img src="https://s2.loli.net/2021/12/29/Fhp7AtekyVGzgQW.png" alt="image-20210510144229295"></p>
<p>为了防止IP数据报在路由环路中永久的兜圈，在IP数据报首部设有生存时间TTL字段</p>
<p>当IP数据报进入路由器后，TTL字段的值就减1，若TTL的值不等于0，则被路由器转发，否则被丢弃</p>
<hr>
<p>聚合了不存在的网络导致的路由环路问题</p>
<p>如果在路由器中聚合了不存在的网络地址，当R2收到后会转发给R1，而R1收到后转发给R2，那么就形成了路由环路</p>
<p><img src="https://s2.loli.net/2021/12/29/qa7doPVQYunMWNy.png" alt="image-20210510145250091"></p>
<p>针对这种情况，可以在R2中添加针对不存在的聚合网络的黑洞路由，一旦IP数据报进入到黑洞路由后就会被丢弃</p>
<p><img src="https://s2.loli.net/2021/12/29/5jxPcpa2L6KwoSI.png" alt="image-20210510145407140"></p>
<p>因为黑洞路由更具体，所以会优先转发黑洞路由</p>
<hr>
<p>网络故障导致的路由环路</p>
<p>假设路由器自动检测到其中的一条直连网络出现了故障而不可达，就会在路由表中删除该条目，如果R2转发数据给地址，会通过R1转发，R1查找不到该地址，又通过默认路由到R2中，形成了路由环路</p>
<p><img src="https://s2.loli.net/2021/12/29/cQ4rKRTMhGlUZWb.png" alt="image-20210510145726319"></p>
<p>针对这种情况，可以在R1中添加针对被删除网络的黑洞路由，这样就不会形成环路了</p>
<hr>
<h2 id="路由选择协议"><a href="#路由选择协议" class="headerlink" title="路由选择协议"></a>路由选择协议</h2><h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><p>路由协议分为静态路由选择和动态路由选择</p>
<p>静态路由选择方式相对简单，但不能及时适应网络变化，所以一般在小规模网络中采用</p>
<p>动态路由选择方式比较复杂，能较好地适应网络状态的变化，所以适用于大规模网络</p>
<p>因特网所采用的路由选择协议的主要特点：</p>
<ul>
<li>自适应：动态路由选择，能较好适应网络状态</li>
<li>分布式：路由器之间交换路由信息</li>
<li>分层次：将整个因特网分为许多较小的自治系统AS</li>
</ul>
<p>在自治系统内部使用的协议是内部网络协议IGP，在两个自治系统之间使用的协议是外部网关协议EGP</p>
<p><img src="https://s2.loli.net/2021/12/29/BYQa8eXrswFIhyG.png" alt="image-20210510150638806"></p>
<p>RIP和IGRP基于距离向量，OSPF和IS-IS基于链路状态</p>
<hr>
<h3 id="路由器的基本结构"><a href="#路由器的基本结构" class="headerlink" title="路由器的基本结构"></a>路由器的基本结构</h3><p>路由器是一种具有多个输入端口和输出端口的专用计算机，任务是转发分组</p>
<p>路由器可以划分为路由选择部分和分组转发部分</p>
<p><img src="https://s2.loli.net/2021/12/29/RHPzq4sQo63StN9.png" alt="image-20210510152558418"></p>
<p>路由表如果收到了路由报文就会更新自己的路由表</p>
<ul>
<li>路由表一般仅包含从目的网络下一跳的映射</li>
<li>路由表需要对网络拓扑变化的计算最优化</li>
<li>转发表是从路由表得出的</li>
<li>转发表的结构应当使查找过程最优化</li>
</ul>
<hr>
<h3 id="路由信息协议RIP"><a href="#路由信息协议RIP" class="headerlink" title="路由信息协议RIP"></a>路由信息协议RIP</h3><p>路由信息协议RIP(Routing Information Protocol)是内部网关协议IGP中最先得到广泛使用的协议之一</p>
<p>RIP要求自治系统AS内的每一个路由器都要维护从它自己到AS内其它每一个网络的距离记录。这是一组距离，称为“距离向量D-V(Distance-Vector”</p>
<p>RIP使用跳数作为度量来衡量到达目的网络的距离</p>
<ul>
<li>路由器到直连网络的距离定义为1</li>
<li>路由器到非直连网络的距离定义为经过的路由器数加1</li>
<li>允许一条路径最多只能包含15个路由器。<strong>距离等于16相当于不可达</strong>，所以RIP只适用于小型互联网</li>
<li>RIP被封装在UDP协议中</li>
</ul>
<p>RIP协议认为“距离短”的路由就是最优选择的路由，也就是所通过路由器数量最少的路由</p>
<p><img src="https://s2.loli.net/2021/12/29/jetkNZxXP1vmW7g.png" alt="image-20210510180046128"></p>
<p>尽管R1到R2的带宽，但是RIP会认为R1到R4的更好</p>
<p>到到达同一网络由多条距离相等的路由时，可以进行<strong>等价负载均衡</strong>，也就是将通信量均衡地分布到多条等价的路由上</p>
<p><img src="https://s2.loli.net/2021/12/29/t1J3IjNDwMaTeAQ.png" alt="image-20210510180254683"></p>
<p>RIP包含有以下三个要点</p>
<ul>
<li>和谁交换信息    仅和相邻路由器交换信息</li>
<li>交换什么信息    自己的路由表</li>
<li>合适交换信息    周期性交换</li>
</ul>
<p><img src="https://s2.loli.net/2021/12/29/gMuyKjoIRkP5flY.png" alt="image-20210510180407506"></p>
<hr>
<p>RIP的基本工作过程</p>
<ol>
<li>当路由器刚开始工作的时，只知道自己到直连网络的距离为1，并不知道和自己相邻路由器的信息</li>
<li>每个路由器仅和相邻路由器周期性地交换并更新路由信息</li>
<li>若干次交换和更新后，每个路由器都知道到达本AS内各网络的最短距离和下一跳地址，称为<strong>收敛</strong></li>
</ol>
<p><img src="https://s2.loli.net/2021/12/29/Tx6i5XuY4WBKPFn.png" alt="image-20210510181014661"></p>
<hr>
<p>RIP更新报文</p>
<p><img src="https://s2.loli.net/2021/12/29/iOctXFuBf3dQ2P1.png" alt="image-20210510181150740"></p>
<p>这是C的路由表，而C的相邻路由器接收到该路由表时，会对其进行改造，成如下形式</p>
<p><img src="https://s2.loli.net/2021/12/29/hQfDsGw4CBWAkLH.png" alt="image-20210510181341506"></p>
<p>所有的距离加1，并且下一跳都变为C</p>
<p><img src="https://s2.loli.net/2021/12/29/wUAmhykHxJFpnlT.png" alt="image-20210510181433801"></p>
<p>然后对比C的路由表和自己的路由表</p>
<ul>
<li>如果目的网络和下一跳一样，则要更新信息</li>
<li>发现了新的网络，进行添加</li>
<li>如果目的网络一样，距离一样，下一跳不一样，就进行等价负载均衡</li>
<li>如果目的网络一样，距离不一样，下一跳不一样，如果新路由的距离短，则更新信息，如果距离更长，则不更新</li>
</ul>
<hr>
<p>RIP存在有坏消息传播得慢这一问题</p>
<p><img src="https://s2.loli.net/2021/12/29/2CgVGtcKAukY4va.png" alt="image-20210510181845024"></p>
<p>如果N1故障了，R1会将其距离设置为16，并把信息传输给R2，R2之前的路由表信息是，到达N1的距离为2，因为路由表在周期性的更新信息</p>
<p>那么，如果R2的路由器信息更早的到达的R1，R1则不再会认为到N1的距离为16，而是会更新为3，同时将此路由表信息传输给R2,R2接受到后，就会认为到达N1的距离为4</p>
<p><img src="https://s2.loli.net/2021/12/29/QrmzCp6uxqcGRPV.png" alt="image-20210510182217999"></p>
<p>直到R1和R2都认为到N1的距离为16才会终止</p>
<p>”坏消息传的慢“，又称为路由环路或距离无穷计数问题，这是距离向量算法的一个固有问题，可以采取多种措施减少出现该问题的概率或减少该问题带来的危害</p>
<ul>
<li>设置最大路径距离为15</li>
<li>当路由表发生变化的时候立即发送更新报文(触发更新)，而不是周期性发送</li>
<li>让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送(即水平分割)</li>
</ul>
<hr>
<h3 id="开放最短路径优先OSPF"><a href="#开放最短路径优先OSPF" class="headerlink" title="开放最短路径优先OSPF"></a>开放最短路径优先OSPF</h3><p>开放最短路径优先OSPF(Open Shortest Path First)是为了克服RIP的缺点而开发出来的</p>
<ul>
<li>“开放”表明OSPF不是受某一家厂商控制，而是公开发表的</li>
<li>“最短路径优先”是因为使用了迪杰斯特拉提出的最短路径算法SPF</li>
</ul>
<p>OSPF采用SPF算法计算路由，从算法上保证了不会产生路由环路</p>
<p>OSPF基于<strong>链路状态</strong>，而不像RIP那样是基于距离向量的</p>
<p>OSPF采用SPF算法计算路由，从算法上保证了<strong>不会产生路由环路</strong></p>
<p>OSPF<strong>不限制网络规模</strong>，更新效率高，收敛速度快</p>
<p>链路状态是指本路由器都和哪些路由器相邻，以及相应链路的“代价”(cost)</p>
<ul>
<li>代价可以是很多指标，比如距离，时延，带宽等由网络管理人员决定</li>
</ul>
<hr>
<p>OSPF报文</p>
<p>OSPF相邻路由器之间通过交互问候(Hello)分组，建立和维护邻居关系</p>
<ul>
<li><p>Hello分组封装在IP数据报中，发往组播地址224.0.0.5(所有的OSPF路由器)</p>
</li>
<li><p><img src="https://s2.loli.net/2021/12/29/jh4Q9NSZiBwUu7H.png" alt="image-20210510191725479"></p>
</li>
<li><p>发送周期为10秒</p>
</li>
<li><p>如果40秒未收到来自邻居路由器的Hello分组，则认为该邻居路由器不可达</p>
</li>
</ul>
<p>使用OSPF的每个路由器都会产生链路状态通告LSA(Link State Advertisement)，LSA包含以下信息：</p>
<ul>
<li>直连网络的链路状态信息</li>
<li>邻居路由器的链路状态信息</li>
</ul>
<p>LSA被封装在链路状态更新分组LSU中，采用洪泛法发送</p>
<p>使用OSPF的每个路由器都有一个<strong>链路状态数据库LSDB</strong>，用于存储LSA</p>
<p>通过各路由器洪范发送封装有自己LSA的LSU分组，各路由器的LSDB最终<strong>达成一致</strong></p>
<p>使用OSPF的各路由器基于LSDB进行最短路径优先SPF计算，构建出各自到达其他路由器的最短路径，即构建各自的路由表</p>
<p><img src="https://s2.loli.net/2021/12/29/cfeYLoaObS9Z3WQ.png" alt="image-20210510194954434"></p>
<hr>
<p>OSPF的工作原理</p>
<p>OSPF有以下5种分组</p>
<ul>
<li>问候分组 用来发现和维护邻居路由器的可达性</li>
<li>数据库描述 向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息</li>
<li>链路状态请求 向邻居路由器请求发送某些链路状态项目的详细信息</li>
<li>链路状态更新(LSU) 路由器使用这种分组进行洪泛转发</li>
<li>链路状态确认 对LSU的确认分组</li>
</ul>
<p><img src="https://s2.loli.net/2021/12/29/bhkCQRda3Yx2wo6.png" alt="image-20210510193341006"></p>
<p>每30分钟或者链路状态发生变化，都会通过洪泛法来发送LSU，并给该路由器发送确认分组</p>
<hr>
<p>OSPF在多点接入网络中，很容易产生多个多播分组</p>
<p><img src="https://s2.loli.net/2021/12/29/wZnhLPzDITUm4jg.png" alt="image-20210510193626726"></p>
<p>为了减少多播分组的发送，OSPF采用选举指定路由器DR(Designated Router)和备用的指定路由器BDR的方法</p>
<p><strong>所有的非DR/BDR只与DR/BDR建立邻居关系，通过其交换网络</strong></p>
<p><img src="https://s2.loli.net/2021/12/29/ik1L5XhGtIJBrqV.png" alt="image-20210510193841039"></p>
<hr>
<p>为了让OSPF能够用于规模更大的网络，OSPF把一个自治系统再划分为若干个更小的区域(Area)</p>
<p><img src="https://s2.loli.net/2021/12/29/b1xQRpkevwFZHJl.png" alt="image-20210510194014162"></p>
<p>可以降低洪泛法交换信息的范围局限在每个区域内</p>
<p>区域内路由器IR(Inter Router)：接口都完全在一个区域内的路由器</p>
<p>区域边界路由器ABR(Area Border Router)：一个接口用于连接自身区域，另一个用于连接主干</p>
<p>主干路由器BR(Backbone Router)：主干区域内的路由器</p>
<p>自治系统边界路由器ASBR(AS Border Router)：专门用于和其他自治系统交换信息</p>
<hr>
<h3 id="边界网关协议-BGP"><a href="#边界网关协议-BGP" class="headerlink" title="边界网关协议(BGP)"></a>边界网关协议(BGP)</h3><p>在配置BGP时，每个自治系统的管理员要选择一个路由器作为该自治系统的“BGP发言人”</p>
<p>不同自治系统的BGP发言人要交换路由信息，<strong>首先必须建立TCP连接</strong>，端口号为179</p>
<ul>
<li>在此TCP连接上交换BGP报文以建立BGP会话</li>
<li>利用BGP会话交换路由信息</li>
<li>使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的邻站或对等站</li>
</ul>
<p>BGP发言人除了运行BGP外，还必须运行自己所在自治系统的内部网关协议IGP</p>
<p><img src="https://s2.loli.net/2021/12/29/mbYzl7Rw9rq5OtV.png" alt="image-20210510200357288"></p>
<p>BGP发言人交换网络可达性的信息</p>
<p>当BGP发现人交换了网络可达性信息之后，各BGP发言人就根据所采用的策略从收到的信息中找出到达各自治系统的较好的路由，也就是构造出树形结构，不存在环路的连通图</p>
<p>BGP-4有以下4种报文</p>
<p>OPEN 打开报文 ：用来与相邻的另一个BGP发言人建立关系，让通信初始化</p>
<p>UPDATE 更新报文 ：用来通告某一路由信息，以及列出要撤销的路由</p>
<p>KEEPLIVE 保活报文：用来周期性地证实邻站的连通性</p>
<p>NOTIFICATION 通知报文：用来发送检测到的差错</p>
<hr>
<h2 id="IPv4数据报的首部格式"><a href="#IPv4数据报的首部格式" class="headerlink" title="IPv4数据报的首部格式"></a>IPv4数据报的首部格式</h2><p><img src="https://s2.loli.net/2021/12/29/BpcMX15ytDbiVGm.png" alt="image-20210510201659621"></p>
<p>固定部分是每个IP数据报都要包含的内容，可变字段是可以根据需求添加的内容</p>
<ul>
<li><strong>版本</strong></li>
</ul>
<p>占4个比特，表示IP协议的版本，通信协议的IP协议版本必须一致，目前广泛使用的是IPv4</p>
<ul>
<li><strong>首部长度</strong></li>
</ul>
<p>占4比特，用来表示IP数据报首部的长度，该字段的取值以4字节为单位</p>
<p>最小10进制取值为5，表示只有20字节固定部分，最大10进制取值为15，表示20字节固定部分和最大400字节可变部分</p>
<ul>
<li><strong>可选字段</strong></li>
</ul>
<p>长度从1个字节到40个字节不等，用来支持排错，测量以及安全等措施，实际上很多被使用</p>
<ul>
<li><strong>填充字段</strong></li>
</ul>
<p>用来确保首部长度为4字节的整数倍，使用全0进行填充</p>
<ul>
<li><strong>区分服务</strong></li>
</ul>
<p>占8个比特，利用该字段的不同数值可提供不同等级的服务质量，一般情况下不使用</p>
<ul>
<li><strong>总长度</strong></li>
</ul>
<p>站16比特，表示IP数据报的总长度(首部+数据载荷)</p>
<p>最大取值为十进制的65535，以字节为单位</p>
<p><img src="https://s2.loli.net/2021/12/29/sYpZA9k1ouI3mra.png" alt="image-20210510203030287"></p>
<p><strong>标识，标志，片偏移</strong>三个字段共同用于IP数据报分片</p>
<p>以太网的数据链路层鬼听MTU的值为1500字节，如果IP数据报的大小超过了这么多，就需要进行分片</p>
<p><img src="https://s2.loli.net/2021/12/29/ISBAp8NTQqnUdig.png" alt="image-20210510203710260"></p>
<ul>
<li><strong>标识</strong></li>
</ul>
<p>占16比特，属于同一个数据报的各分片数据报应该具有相同的标识</p>
<ul>
<li><strong>标志</strong></li>
</ul>
<p>占3个比特，各比特含义如下</p>
<p>DF位：1表示不允许分片 0表示允许分片</p>
<p>MF位：1表示后面还有分片 0表示这是最后一个分片</p>
<p>保留位：必须为0</p>
<ul>
<li><strong>片偏移</strong></li>
</ul>
<p>占13个比特，指出分片数据报的数据载荷部分偏移其原数据报的位置有多少个单位</p>
<p>以8个字节为单位</p>
<p>因为片偏移量<strong>以8个字节为单位</strong>，<strong>所以除了第一个分片外，其余分片的数据载荷必须是8的整数倍</strong>，在分片的时候需要注意</p>
<ul>
<li><strong>生存时间</strong></li>
</ul>
<p>占8个比特，以条数为单位，转发IP数据报时，将IP数据报首部中的该字段的值减1，若不为0则转发</p>
<ul>
<li><strong>协议</strong></li>
</ul>
<p>占8个比特，指明IPv4数据报的数据部分是何种协议数据单元</p>
<p><img src="https://s2.loli.net/2021/12/29/pI47QveCkDzjMUJ.png" alt="image-20210510205506569"></p>
<ul>
<li><strong>首部检验和</strong></li>
</ul>
<p>占16个比特，用来检测首部在传输工程中是否出现差错，比CRC检验码简单，称为因特网检验和</p>
<p>IP数据报没经过一个路由器，路由器都要重新计算首部检验和，因为某些字段可能会发生变化，在IPv6中不再计算检验和</p>
<ul>
<li><strong>源IP地址和目的IP地址</strong></li>
</ul>
<p>各占32比特，用来填写发送该IP数据报的源主机的IP地址和接收该IP数据报的目的主机的IP地址</p>
<hr>
<h2 id="网际控制报文协议ICMP"><a href="#网际控制报文协议ICMP" class="headerlink" title="网际控制报文协议ICMP"></a>网际控制报文协议ICMP</h2><p>主机或路由器通过ICMP(Internet Control Message Protocol)来发送差错报告报文和询问报文</p>
<p>被封装在IP数据报中发送</p>
<p>报文一共有一下5种</p>
<ul>
<li>终点不可达</li>
</ul>
<p>当路由器或主机无法交付数据报时，就向源点发送终点不可达报文</p>
<ul>
<li>源点抑制</li>
</ul>
<p>当路由器或主机由于拥塞而丢弃数据时，就向源点发送源点抑制报文</p>
<ul>
<li>时间超过</li>
</ul>
<p>若转发的数据报的生存时间为0，除了丢弃该数据报，还要向源点发送时间超过报文</p>
<ul>
<li>参数问题</li>
</ul>
<p>如果路由器或目的主机收到IP数据报后，根据其首部的检验和字段发现了误码，就丢弃该数据报，并且向源点发送参数问题报文</p>
<ul>
<li>改变路由</li>
</ul>
<p>路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的主机</p>
<p>以下情况不该发送ICMP差错报告报文</p>
<ul>
<li>对ICMP差错报文不应发送ICMP差错报文</li>
<li>对第一个分片的数据报文的所有后序报文都不发送ICMP差错报告报文</li>
<li>对具有多播地址的数据报不发送</li>
<li>对具有特殊地址的数据报(127.0.0.0或0.0.0.0)不发送</li>
</ul>
<hr>
<p>ICMP询问报文主要有两种</p>
<ul>
<li>回送请求和回答</li>
</ul>
<p>ICMP回送请求是由主机或路由器向一个特定的目的主机发出的询问，收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文，用来测试目的站是否可达</p>
<ul>
<li>时间戳请求和回答</li>
</ul>
<p>ICMP时间戳请求报文是请某个主机或路由器回答当前的时间和日期，用来进行时钟同步和测量时间</p>
<hr>
<h2 id="虚拟专用网VPN"><a href="#虚拟专用网VPN" class="headerlink" title="虚拟专用网VPN"></a>虚拟专用网VPN</h2><p>虚拟专用网VPN(Virtual Private Network)：利用公网的因特网作为本机构各专用网之间的通信载体</p>
<p>由于IPv4地址的紧缺，一个机构所申请到的地址数量很少，因此，虚拟专用网中各主机所分配的地址应该是本机构可只有分配的专用地址，而不是需要申请的，在因特网上使用的公有地址</p>
<p>有10.0.0.0~10.255.255.255(10/8地址块) 172.16.0.0~172.31.255.255(172.16/12地址块)</p>
<p>   192.168.0.0~192.168.255.255(192.168/16地址块)</p>
<p>私有地址只能用于内部通信，不能在因特网上传输，路由器对目的地址是私有地址的IP数据报一律不进行转发</p>
<p>很显然，两个私有地址之间要实现远程通信，需要两个有公网IP的路由器</p>
<p>假设需要远程通信，在主机1把数据包传送给路由器1，路由器1吧IP数据报加密，然后用IP数据报的形式通过因特网传输到路由器2，路由器2解析加密的IP数据报，然后把数据发送给主机2</p>
<p><img src="https://s2.loli.net/2021/12/29/IFujaoiqhW9sNmd.png" alt="image-20210510224501522"></p>
<p>从逻辑上看来R1和R2好像是点对点链路，所以也把这种技术称为IP隧道技术</p>
<p>同一机构内不同部分的内部网络所构成的虚拟专用网VPN又称为内联网VPN</p>
<p>有时一个结构的VPN需要有某些外部机构参与进来，这样的VPN称为外联网VPN</p>
<p>在外地工作的员工需要访问公司内部的专用网络时，只要在任何地点接入到因特网，运行PC中的VPN软件，在员工的PC和公司的主机之间建立VPN隧道，即可以访问专用网络中的资源，这种VPN称为远程接入VPN</p>
<hr>
<h2 id="网络地址转换NAT"><a href="#网络地址转换NAT" class="headerlink" title="网络地址转换NAT"></a>网络地址转换NAT</h2><p>NAT(Network Address Translation)：能使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源</p>
<p>使用私有地址的主机想要与因特网的主机上进行通信，需要一个NAT路由器，至少有一个有效地外部全球IP地址，所有的使用私有地址的主机在和外界通信的时候都要在NAT路由器上将IP地址转换成全球IP地址</p>
<p><img src="https://s2.loli.net/2021/12/29/c9Dv1RWkzLEfew5.png" alt="image-20210510225648917"></p>
<p>NAT路由器会建立一个转换表来记录私有地址和全球IP地址之间的转换关系</p>
<p>该转换方法存在一个问题：如果NAT路由器具有N个全球IP地址，那么至多有N个内网主机能够同时和因特网上的主机通信</p>
<p>所以推出了网络地址与端口转换技术NAPT，将运输层的端口号和IP地址一起转换，这样用一个全球IP地址就可以使多个拥有本地地址的主机同时和因特网上的主机进行通信</p>
<p><img src="https://s2.loli.net/2021/12/29/jiBPgp34nEWvFot.png" alt="image-20210510235817887"></p>
<p>对于一些P2P网络应用，需要外网主机主动与内网主机进行通信，在通过NAT时会遇到问题，需要网络应用自己使用一些特殊的NAT穿越技术来解决问题</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/17624.html"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">3.数据链路层</div></div></a></div><div class="next-post pull-right"><a href="/post/9992.html"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">5.运输层</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/candle1220/CDN/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Candle</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">144</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%B1%82"><span class="toc-number">1.</span> <span class="toc-text">网络层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%B1%82%E6%8F%90%E4%BE%9B%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">网络层提供的服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPv4%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.</span> <span class="toc-text">IPv4地址</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">1.3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%B1%BB%E7%BC%96%E5%9D%80%E7%9A%84IPv4%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.2.</span> <span class="toc-text">分类编址的IPv4地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%92%E5%88%86%E5%AD%90%E7%BD%91%E7%9A%84IPv4%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.3.</span> <span class="toc-text">划分子网的IPv4地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%88%86%E7%B1%BB%E7%BC%96%E5%9D%80%E7%9A%84IPv4%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.4.</span> <span class="toc-text">无分类编址的IPv4地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPv4%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BA%94%E7%94%A8%E8%A7%84%E5%88%92"><span class="toc-number">1.3.5.</span> <span class="toc-text">IPv4地址的应用规划</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IP%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%8F%91%E9%80%81%E5%92%8C%E8%BD%AC%E5%8F%91%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.4.</span> <span class="toc-text">IP数据报发送和转发的过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE%E5%92%8C%E8%B7%AF%E7%94%B1%E7%8E%AF%E8%B7%AF"><span class="toc-number">1.5.</span> <span class="toc-text">静态路由配置和路由环路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.6.</span> <span class="toc-text">路由选择协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="toc-number">1.6.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%99%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.2.</span> <span class="toc-text">路由器的基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF%E5%8D%8F%E8%AE%AERIP"><span class="toc-number">1.6.3.</span> <span class="toc-text">路由信息协议RIP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E6%94%BE%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84%E4%BC%98%E5%85%88OSPF"><span class="toc-number">1.6.4.</span> <span class="toc-text">开放最短路径优先OSPF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%B9%E7%95%8C%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE-BGP"><span class="toc-number">1.6.5.</span> <span class="toc-text">边界网关协议(BGP)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPv4%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%9A%84%E9%A6%96%E9%83%A8%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.7.</span> <span class="toc-text">IPv4数据报的首部格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E9%99%85%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87%E5%8D%8F%E8%AE%AEICMP"><span class="toc-number">1.8.</span> <span class="toc-text">网际控制报文协议ICMP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E4%B8%93%E7%94%A8%E7%BD%91VPN"><span class="toc-number">1.9.</span> <span class="toc-text">虚拟专用网VPN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2NAT"><span class="toc-number">1.10.</span> <span class="toc-text">网络地址转换NAT</span></a></li></ol></li></ol></div></div><div class="card-widget card-recommend-post"><div class="item-headline"><i class="fas fa-dharmachakra"></i><span>相关推荐</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/21933.html" title="1.计算机网络—概述"><img src="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg" alt="1.计算机网络—概述"></a><div class="content"><a class="title" href="/post/21933.html" title="1.计算机网络—概述">1.计算机网络—概述</a><time datetime="2021-12-28" title="������ 2021-12-28">2021-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/38801.html" title="2.物理层"><img src="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg" alt="2.物理层"></a><div class="content"><a class="title" href="/post/38801.html" title="2.物理层">2.物理层</a><time datetime="2021-12-28" title="������ 2021-12-28">2021-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/9992.html" title="5.运输层"><img src="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg" alt="5.运输层"></a><div class="content"><a class="title" href="/post/9992.html" title="5.运输层">5.运输层</a><time datetime="2021-12-28" title="������ 2021-12-28">2021-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/60874.html" title="6.应用层"><img src="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg" alt="6.应用层"></a><div class="content"><a class="title" href="/post/60874.html" title="6.应用层">6.应用层</a><time datetime="2021-12-28" title="������ 2021-12-28">2021-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/17624.html" title="3.数据链路层"><img src="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg" alt="3.数据链路层"></a><div class="content"><a class="title" href="/post/17624.html" title="3.数据链路层">3.数据链路层</a><time datetime="2021-12-28" title="������ 2021-12-28">2021-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/13956.html" title="计算机网络重点题"><img src="https://cdn.jsdelivr.net/gh/candle1220/CDN/hacker1.jpg" alt="计算机网络重点题"></a><div class="content"><a class="title" href="/post/13956.html" title="计算机网络重点题">计算机网络重点题</a><time datetime="2021-12-28" title="������ 2021-12-28">2021-12-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Candle</div><div class="framework-info"><span>Powered by </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a></div><div class="footer_custom_text">So Long, and Thanks for All the Fish</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-candle1220.vercel.app',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'https://twikoo-candle1220.vercel.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>